<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Overview of the EDR Architecture</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	

	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
	<header>
	==============<br>
	== <a href="http://rootkall.com/">ROOTKALL</a> ==<br>
	==============
	<div style="float: right;">cybersecurity, mathematics &amp; probably other things.</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>Overview of the EDR Architecture</h1>
			<b><time>07.07.5050 10:00</time></b>
		       

			<div>
				<p><strong>TLDR</strong> ; Endpoint Detection and Response is a defensive product. It is simply an application that runs on target workstations or servers on which it collects data on the security environment called telemetry. In this article, I try to explain the methods EDRs use to collect these information. This is based on an amazing book called Evadin EDR by Matt Hand.</p>
<h2 id="1--components-of-an-edr">1- Components of an EDR</h2>
<h3 id="the-agent">The Agent</h3>
<p>The EDR agent is an application that manages and analyzes data from various sensors to identify activities that might indicate a security threat. It sends this telemetry to a central server for deeper analysis of events across all deployed agents in the environment. When the agent detects suspicious behavior, it can take several actions:</p>
<ul>
<li><strong>Log the incident</strong> as an alert in a central logging system, like the EDR dashboard or a SIEM solution.</li>
<li><strong>Block the malicious action</strong> by signaling a failure to the executing program.</li>
<li><strong>Mislead the attacker</strong> by returning false information, such as incorrect memory addresses, making it seem like their operation was successful even though it ultimately fails.</li>
</ul>
<h3 id="telemetry">Telemetry</h3>
<p>Every sensor in an EDR is designed to collect telemetry, which is the raw data generated by the sensor or the host system. This data, capturing actions like opening a file or creating a process, helps defenders analyze potential malicious activity. Each piece of telemetry acts as a datapoint in the EDR&rsquo;s alerting system. Although individual data points may not provide enough context on their own, when combined, they enable the EDR to assess whether activities are benign or malicious. The EDR&rsquo;s detection logic uses this comprehensive telemetry alongside methods like heuristics or signature libraries to determine the appropriate response, such as logging the event or blocking the action.</p>
<h3 id="sensors">Sensors</h3>
<p>In an EDR, sensors act like the components that detect and transform data into telemetry. Unlike radar systems that continuously scan for objects, EDR sensors passively intercept data flowing through system processes, quickly extracting and forwarding information to a central agent. These sensors must operate extremely fast to avoid introducing delays; for instance, a 5 ms processing time for each registry query could lead to significant slowdowns if many queries occur in a short period. While EDRs have access to numerous telemetry sources, they focus on a select few that offer high-quality, relevant data. Some sensors are built into the operating system, while others may be added by the EDR itself. On the offensive side, understanding how these sensors work allows attackers to minimize the telemetry collected, aiming to create false negatives and evade detection by employing informed strategies based on the data collected by the EDR.</p>
<h3 id="detections">Detections</h3>
<p>Detections in an EDR correlate specific pieces of telemetry with behaviors on the system. They can be simple, such as identifying a file with a known malware hash, or complex, involving multiple events, like a child process of <code>chrome.exe</code> communicating with a domain controller over TCP port 88. Detection engineers write these rules, with those at EDR vendors focusing on scalability for various organizations, while those within a single organization can tailor rules to their specific needs. Detection logic may reside in the EDR agent, its sensors, or the backend collection system, each with its advantages and drawbacks. Agent-based detections allow for immediate preventive actions but may lack the ability to analyze complex scenarios. In contrast, backend detections can manage extensive rules but may introduce delays in response.</p>
<h2 id="2--architecture-of-and-edr">2- Architecture of and EDR:</h2>
<p>Let&rsquo;s take a look at this figure taken from the book Evading EDR which illustrates the usual architecture of EDRs (of course there are more advanced EDR as well as EDR that don&rsquo;t implement all of these methods).</p>
<p>
<figure>
  <img src="https://i.imgur.com/9OiTcOp.png" alt="EDR Architecture" />
</figure>


</p>
<h3 id="static-scanner">Static Scanner</h3>
<p>This component, often integrated into the agent, analyzes files—like Portable Executable (PE) files or sections of virtual memory—to determine if the content is malicious. Static scanners are typically the core of antivirus services.</p>
<h3 id="hooking-dll">Hooking DLL</h3>
<p>This is a Dynamic Link Library (DLL) that intercepts calls to specific application programming interface (API) functions. It plays a key role in function hooking.</p>
<h3 id="kernel-driver">Kernel Driver</h3>
<p>A kernel-mode driver responsible for injecting the hooking DLL into target processes and collecting kernel-specific telemetry. It uses various detection techniques to monitor system activities.</p>
<h3 id="agent-service">Agent Service</h3>
<p>This application collects telemetry generated by the static scanner and the hooking DLL. It may also correlate data or generate alerts before sending the information to a centralized EDR server.</p>
<h3 id="network-filter-drivers">Network Filter Drivers</h3>
<p>These drivers analyze network traffic to spot signs of malicious activity, like beaconing.</p>
<h3 id="filesystem-filter-drivers">Filesystem Filter Drivers</h3>
<p>This is a specialized type of driver that monitors operations on the host filesystem.</p>
<h3 id="etw-consumers">ETW Consumers</h3>
<p>These components of the agent subscribe to events generated by the host operating system or third-party applications, enabling effective monitoring of system activities.</p>
<h3 id="early-launch-antimalware-elam-components">Early Launch Antimalware (ELAM) Components</h3>
<p>These features provide a Microsoft-supported way to load an antimalware driver before other boot services, ensuring control over the initialization of other drivers. They also allow for receiving Secure ETW events, which are generated by protected event providers.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In summary, the various components of an EDR system function as sensors that collectively enhance security by monitoring activities, detecting anomalies, and providing actionable insights. Each component plays a crucial role in forming a comprehensive defense strategy against potential threats, ensuring that organizations can respond swiftly and effectively to security incidents.</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/overview-edr-architecture/">Overview of the EDR Architecture</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2024 <a href="http://rootkall.com/"><b>ROOTKALL</b></a>.
	<a href="https://github.com/lowlevel01"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
